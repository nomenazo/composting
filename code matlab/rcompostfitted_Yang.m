clear;

%initialisation des variables
%y0=[0.1012 0.0202 0.0075 0 0.0044 0.0008 0.010 0 0 0 0 0 5e-4 5e-4 1e-4 1e-4 1e-6 1e-6 0 0 0.86 293 0 0 0 1e-4 0 0 0 0 3e-5];%O2init %kg/kgTM %2.6954e-4

y0=[0.1208 0.023 0.0102 0.63e-3 0.00349 0.0008 0.009 0 0 0 0 0 5e-4 5e-4 1e-4 1e-4 1e-6 1e-6 0 0 0.60 293 0 0 0 1e-4 0 0 0 0 3e-5 0] ; %biochemical composition from article


tspan(1)=0;
for i=2:36
    tspan(i)=tspan(i-1)+24;
end;

%tspan = [0 2000];

options = odeset( 'RelTol',1e-12,'AbsTol',1e-14);

%options = odeset('Events', @events);
%[t,y]=ode45_with_corrections('compostfitted',[tspan],[y0]);
[t,y]=ode15s('compostfitted_Yang',[tspan],[y0],options);




C=y(:,1);
P=y(:,2);
L=y(:,3);
H=y(:,4);
CE=y(:,5);
LG=y(:,6);
Xi=y(:,7);
Sc=y(:,8);
Sp=y(:,9);
Sl=y(:,10);
Sh=y(:,11);
Slg=y(:,12);
Xmb=y(:,13);
Xtb=y(:,14);
Xma=y(:,15);
Xta=y(:,16);
Xmf=y(:,17);
Xtf=y(:,18);
Xdb=y(:,19);
CO2=y(:,20);
W=y(:,21);
T=y(:,22);
CH4gen=y(:,23);
CH4oxi=y(:,24);
CH4=y(:,25);
Xa=y(:,26);
NO3=y(:,27);
N2O=y(:,28);
N2=y(:,29);
NH3=y(:,30);
NH4=y(:,31);
Wvap= y(:,32);





%y = max(0,y);
CH4 = max(0,CH4);

NH4 = max(0,NH4);

CCO2= (0.012/0.044) * CO2;

CCH4 = (0.012/0.016)*CH4;

NNH3 = (0.014/0.017)*NH3;


NN2 = N2;

NN2O = (0.028/0.044)*N2O;

Cinit= 0.1222; 
Ninit = 5e-3;

Ccompost= Cinit - CCO2 - cumsum(CCH4);

Ncompost = Ninit - NNH3- NN2 - NN2O;

CNratio = (Ccompost/Ncompost);
%y(y<0)=0;

dataCO2= [0	0.009822223	0.022605962	0.035887098	0.043670426	0.059216425	0.075787411	0.087725741	0.100288143	0.110657032...
    0.1115704	0.113534804	0.121567152	0.130538493	0.13973814	0.148585943	0.155123658	0.160385789	0.165531836] ; %CO2

dataNH3 = [0	1.39576E-05	1.58721E-05	2.47942E-05	4.39305E-05	5.52872E-05	6.16529E-05	0.000107925	0.000166548	0.000316787 ...
    0.000476459	0.000597819	0.000724282	0.000853253	0.000963093	0.001004187	0.001040919	0.001074571	0.001095098	0.001098855	...
    0.001121305	0.001134244	0.001147253	0.001158885	0.001172199	0.001170175	0.001171289	0.001189092	0.001194185	0.001199914	...
    0.001202424	0.001199751	0.001189394	0.001195208	0.001203086	0.001211964]; 

dataN2O = [0	1.5684E-05	4.00584E-05	9.32119E-05	0.000176873	0.000250205	0.000315905	0.00037687	0.000405114	0.000440218...
    0.00046641	0.000502921	0.000536807	0.000545508	0.000551082	0.000552163	0.000551273	0.000551268	0.000555002	0.000559314...
    0.000566227	0.000571061	0.000572616	0.000573684	0.000574651	0.000576876	0.000578052	0.000581589	0.000580988	0.000580937	...
    0.000579627	0.000580717	0.000580715	0.000582643	0.000583786	0.000584388]; 

dataNO3 = [0	4.09929E-06	8.49361E-06	1.25525E-05	1.25726E-05	1.45512E-05	2.04882E-05	1.9105E-05	2.00988E-05	1.82828E-05 ...
    1.71901E-05	1.84965E-05	1.84304E-05	1.64798E-05	1.68691E-05	2.09135E-05	2.1995E-05	2.37904E-05	2.64103E-05	2.86958E-05	...
    3.17355E-05	3.21772E-05	3.47985E-05	3.64013E-05	3.82473E-05	3.99757E-05	4.16863E-05	4.37595E-05	4.39833E-05	4.95476E-05	...
    5.28926E-05	5.7339E-05	6.2524E-05	6.54987E-05	6.85917E-05	7.48944E-05];

dataCH4 = [0	2.15181E-05	4.48514E-05	9.94793E-05	0.000145397	0.000223058	0.000310853	0.00038972	0.000482004	0.000582044	...
    0.000673131	0.000769457	0.000873233	0.000961021	0.001036843	0.001101693	0.0011556	0.001179214	0.001203666	0.001216514...
    0.001231736	0.001242272	0.001245976	0.001251392	0.001263008	0.001262824	0.001264701	0.001264514	0.001264159	0.001261932	...
    0.001263818	0.00126357	0.001265574	0.001271628	0.001273713 0.001276];

dataCH4d = [0 1.95155E-06 6.48274E-06 2.60566E-05 6.56842E-05 5.55233E-05 8.78856E-05 9.20516E-05 0.000114093 0.000103701 ...
8.80915E-05 0.000102455 0.000100069 8.53698E-05 7.47548E-05 6.26267E-05 5.13218E-05 2.99409E-05 2.60347E-05 2.16979E-05 ...
1.9065E-05 1.99399E-05 9.11593E-06 6.94192E-06 4.40578E-06 1.7358E-06 1.42009E-06 1.40639E-06 1.63831E-06 1.43084E-06 ...
1.18318E-06 1.39761E-06 1.27638E-06 2.11566E-06 2.59064E-06 2.59241E-06];



%subplot(5,1,1);
%plot(t,NH3,'r-',t,dataNH3,'k.');
%xlabel('time (h)');
%ylabel('NH3 (kg/kgTM)');
%subplot(5,1,2);
%plot(t,CO2,'r-'); %,t,dataCO2,'k.')
%xlabel('time (h)');
%ylabel('CO2 (kg/kgTM)');
%subplot(5,1,3);
%plot(t,N2O,'r-', t,dataN2O,'k.')
%xlabel('time (h)');
%ylabel('N2O(kg/kgTM)');
%subplot(5,1,4);
%plot(t,NO3,'r-', t,dataNO3,'k.')
%xlabel('time (h)');
%ylabel('NO3(kg/kgTM)');

subplot(2,1,1);
plot(t,cumsum(CH4), 'r-', t,dataCH4,'k.')
xlabel('time (h)');
ylabel('CH4cumsum(kg/kgTM)');

subplot(2,1,2);
plot(t,CH4,'r-', t,dataCH4d,'k.')
xlabel('time (h)');
%ylabel('CH4(kg/kgTM)');

