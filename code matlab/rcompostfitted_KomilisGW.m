clear;

%initialisation des variables
%y0=[0.0 0.0 0.0 0.156 0.2792 0.1696 0.00 0 0 0 0 0 5e-4 5e-4 1e-4 1e-4
%1e-6 1e-6 0 0 0.72 293 0 0 0 1e-4 0 0 0 0 0.00036];%O2init %kg/kgTM
%%2.6954e-4 database calculation
y0=[0.0155 0.0155 0.011 0.051 0.1224 0.109 0.00 0 0 0 0 0 5e-4 5e-4 1e-4 1e-4 1e-6 1e-6 0 0 0.65 293 0 0 0 1e-4 0 0 0 0 0.00036]; %Komilis composition analyse%assumpion soluble matter = 50%C + 50%P




%tspan(1)=0;
%for i=2:91
%    tspan(i)=tspan(i-1)+24;
%end;

tspan = [0 2400];

options = odeset( 'RelTol',1e-12,'AbsTol',1e-14);

%options = odeset('Events', @events);
%[t,y]=ode45_with_corrections('compostfitted',[tspan],[y0]);
[t,y]=ode15s('compostfitted_Npart',[tspan],[y0],options)




C=y(:,1);
P=y(:,2);
L=y(:,3);
H=y(:,4);
CE=y(:,5);
LG=y(:,6);
Xi=y(:,7);
Sc=y(:,8);
Sp=y(:,9);
Sl=y(:,10);
Sh=y(:,11);
Slg=y(:,12);
Xmb=y(:,13);
Xtb=y(:,14);
Xma=y(:,15);
Xta=y(:,16);
Xmf=y(:,17);
Xtf=y(:,18);
Xdb=y(:,19);
CO2=y(:,20);
W=y(:,21);
T=y(:,22);
CH4gen=y(:,23);
CH4oxi=y(:,24);
CH4=y(:,25);
Xa=y(:,26);
NO3=y(:,27);
N2O=y(:,28);
N2=y(:,29);
NH3=y(:,30);
NH4=y(:,31);





%y = max(0,y);
CH4 = max(0,CH4);

NH4 = max(0,NH4);

CCO2= (0.012/0.044) * CO2;

CCH4 = (0.012/0.016)*CH4;

NNH3 = (0.014/0.017)*NH3;


NN2 = N2;

NN2O = (0.028/0.044)*N2O;

Cinit= 0.1288; 
Ninit = 0.008/0.6;

Ccompost= Cinit - CCO2 - cumsum(CCH4);

Ncompost = Ninit - NNH3- NN2 - NN2O;

CNratio = Ccompost/Ncompost;
%y(y<0)=0;

dataCO2= [0	0.010658307	0.012064092	0.020488396	0.023870271	0.030051839	0.032267393  ...
    0.034299089	0.038006534	0.039503369	0.040739904	0.042901283	0.044411015	0.045248496 ...
    0.047254084	0.048646905	0.049735599	0.049812045	0.051551822	0.051782538	0.053578481 ...
    0.054737495	0.05584828	0.056941472	0.057660209	0.058723218	0.059132392	0.059721854 ...
    0.060876461	0.062067494	0.062106234	0.062848158	0.063068093	0.063059189	0.063047242 ...
    0.063277004	0.063419717	0.063739185	0.06404356	0.064904292	0.065162834	0.064998938  ...
    0.066034943	0.06645967	0.066818461	0.066716552	0.067741576	0.068010284	0.067975709	...
    0.068245469	0.06884277	0.069147466	0.069376341	0.069798145	0.06985545	0.069630769	...
    0.070680557	0.070905549	0.070939253	0.070902227	0.071318185	0.071257984	0.071469734	...
    0.071710832	0.071979559	0.072027407	0.072160354	0.072529026	0.072921378	0.072858746	...
    0.073311255	0.073726422	0.073782105	0.073784744	0.073763294	0.073971598	0.073904728	...
    0.074438034	0.074721419	0.07484848	0.075038274	0.075373127	0.075577342	0.075553739	...
    0.075661505	0.075922374	0.075913674	0.075927796	0.07593392	0.076546655	0.076825088	] ; %...
   % 0.076796612	0.07708573	0.077181414	0.077353359	0.076898372]; %CCO2

dataNH3 = [9.50523E-05	8.3184E-05	8.5979E-05	9.59316E-05	0.000113998	0.000148685	0.000275354	0.000453294	0.000663354 ...
    0.000877706	0.001094094	0.001477452	0.001856072	0.002462657	0.003061782	0.003358049	0.003850929	0.004161586	0.00448449 ...
    0.00491856	0.005432504	0.005863488	0.006036313	0.006277233	0.006532356	0.006828961	0.007146364	0.007286909	0.007411799 ...
    0.00759065	0.007764798	0.007871677	0.007871931	0.007945459	0.008094275	0.008162866	0.008215585	0.008415265	0.008606776 ...
    0.008647248	0.008756188	0.008901962	0.009115249	0.009276016	0.009311398	0.009375908	0.009428734	0.009494994	0.009580957	...
    0.009629212	0.009666273	0.009696949	0.00973921	0.009769989	0.009781303	0.009807082	0.009830799	0.009861079	0.00987839 ...
    0.009883663	0.009893537	0.009899967	0.009941319	0.009968676	0.009983343	0.010006289	0.009984702	0.009981679	0.010014646	...
    0.01003884	0.010053253	0.010052459	0.010067748	0.010092195	0.010103562	0.010108216	0.010127495	0.010150719	0.010153972	...
    0.010160904	0.010176637	0.010192993	0.010204598	0.010211709	0.010217376	0.010233124	0.01024688	0.010250307	0.010252842	0.01027212	0.010298132]; %NH3



%subplot(3,1,1);
%plot(t,CCO2,'r-',t,dataCO2,'k.');
%title('Production of CCO2');
%xlabel('time (h)');
%ylabel('CO2-C (kg/kgTM)');
%subplot(4,1,1);
%plot(t,NH4,'r-') %,t,dataCO2,'k.');
%title('Production of NH4');
%xlabel('time (h)');
%ylabel('NH4 (kg/kgTM)');
%subplot(4,1,2);
%plot(t,NNH3,'r-',t,dataNH3,'k.');
%xlabel('time (h)');
%ylabel('NH3-N (kg/kgTM)');


subplot(2,1,1);
plot(t,NH3,'r-') ; %,t,dataNH3,'k.');
xlabel('time (h)');
ylabel('NH3 (kg/kgTM)');
subplot(2,1,2);
plot(t,NH4,'r-')
xlabel('time (h)');
ylabel('NH4 (kg/kgTM)');


%subplot(7,1,2);
%plot(t,CCO2);
%xlabel('Time (h)');
%ylabel('CCO2 (kg/kgTM)');
%subplot(7,1,3);
%plot(t,O2diss);
%xlabel('Time (h)');
%ylabel('O2diss (kg/kgTM)');
%subplot(7,1,4);
%plot(t,P);
%xlabel('Time (h)');
%ylabel('P (kg/kgTM)');
%subplot(7,1,5);
%plot(t,L);
%xlabel('Time (h)');
%ylabel('L (kg/kgTM)');
%subplot(5,1,5);
%plot(t,O2in);
%xlabel('Time (h)');
%ylabel('O2in (kg/kgTM)');